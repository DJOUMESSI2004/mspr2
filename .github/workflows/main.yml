name: CI/CD MSPR2

on:
  push:
    branches: [master, model, etl]
  pull_request:
    branches: [master, model, etl]

jobs:
  build:
    name: Build des services
    runs-on: ubuntu-latest
    steps:
      - name: R√©cup√©ration du code
        uses: actions/checkout@v3
      - name: Installer Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose version
      - name: Build des images Docker
        run: docker-compose build
      - name: Notification Build
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Build termin√©"
          body: |
            Le build a √©t√© effectu√© avec succ√®s.
            üîó Voir les d√©tails : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.TEAM_EMAILS }}
          from: ${{ secrets.EMAIL_USERNAME }}

  analyse:
    name: Analyse du code (flake8)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Installer flake8
        run: pip install flake8
      - name: Ex√©cuter flake8
        run: cd ml && flake8 . || true
      - name: Notification Analyse
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üîç Analyse de code termin√©e"
          body: |
            L'analyse flake8 a √©t√© effectu√©e.
            üîó Voir les d√©tails : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.TEAM_EMAILS }}
          from: ${{ secrets.EMAIL_USERNAME }}

  tests:
    name: Tests unitaires
    runs-on: ubuntu-latest
    needs: analyse
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Installer d√©pendances
        run: pip install -r ml/requirements.txt
      - name: Ex√©cuter les tests
        id: tests
        run: pytest ml/tests
      - name: Notification Tests
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üß™ R√©sultats des tests"
          body: |
            R√©sultat des tests : ${{ steps.tests.outcome }}
            üîó Voir les logs : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.TEAM_EMAILS }}
          from: ${{ secrets.EMAIL_USERNAME }}

  simulate_deploy:
    name: Simulation de d√©ploiement
    runs-on: windows-latest
    needs: tests
    steps:
      - uses: actions/checkout@v3
      - name: Simuler le d√©ploiement (FR, US, CH)
        run: powershell.exe -ExecutionPolicy Bypass -File simulation_deploiement/simulate-ftp-deploy.ps1 -Countries fr,us,ch
      - name: Notification D√©ploiement
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "üöÄ D√©ploiement simul√© effectu√©"
          body: |
            Le d√©ploiement simul√© a √©t√© effectu√©.
            üîó FR : https://fake.deploy/fr
            üîó US : https://fake.deploy/us
            üîó CH : https://fake.deploy/ch
            üîó Voir les d√©tails : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.TEAM_EMAILS }}
          from: ${{ secrets.EMAIL_USERNAME }}